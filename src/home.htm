<!doctype html>

<html lang="en">

<head>

  <meta charset="utf-8">
  <title>OpenEVSE</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="viewport" content="width=device-width, user-scalable=no" />
  <meta name="description" content="OpenEVSE">
  <meta name="author" content="OpenEVSE">
  <meta name="theme-color" content="#000000" />
  <link rel="stylesheet" type="text/css" href="style.css">
  <link rel="icon" type="image/png" href="favicon-32x32.png" sizes="32x32" />
  <link rel="icon" type="image/png" href="favicon-16x16.png" sizes="16x16" />
  <link rel="apple-touch-icon" href="favicon-180.png" sizes="180x180">
  <link rel="apple-touch-icon" href="favicon-167.png" sizes="167x167">
  <link rel="apple-touch-icon" href="favicon-152.png" sizes="152x152">

</head>

<body>
  <div id="page">
    <div class="header">
      <h1>Open<span>EVSE</span></h1>
      <h3>WiFi</h3>
    </div>

    <div class="container" data-bind="visible: !initialised()">
      Loading, please wait... (<span data-bind="text: itemsLoaded"></span>/<span data-bind="text: itemsTotal"></span>)
    </div>

    <div class="container" data-bind="visible: initialised" style="display: none">

      <div class="tabs">
        <input id="tab-3" type="radio" name="tab-group" data-bind="checked: tab" value="status" />
        <label for="tab-3">OpenEVSE</label>
        <input id="tab-1" type="radio" name="tab-group" data-bind="checked: tab" value="system" />
        <label for="tab-1">System</label>
        <input id="tab-2" type="radio" name="tab-group" data-bind="checked: tab" value="services" />
        <label for="tab-2">Services</label>
        <input id="tab-4" type="radio" name="tab-group" data-bind="checked: tab" value="rapi" />
        <label for="tab-4" data-bind="visible: developerMode() &amp;&amp; status.evse_connected()">RAPI</label>
        <input id="tab-5" type="radio" name="tab-group" data-bind="checked: tab" value="vehicle" />
        <label for="tab-5">Vehicle</label>
      </div>

      <div id="content">
        <!--TAB 1: System -->
        <div id="content-1" data-bind="visible: isSystem">
          <div class="box380 left">
            <h2>WiFi Setup</h2>
            <p><b>Mode:</b> <span id="mode" data-bind="text: status.fullMode"></span></p>

            <div id="wired-view" data-bind="visible: status.isWired">
              <p><b>IP Address:</b><br><a data-bind="text: status.ipaddress, attr: {href: 'http://'+status.ipaddress()}"></a></p>
              <p>
                <b>Successful packets:</b><br>
                <span data-bind="text: status.packets_success"></span> of <span data-bind="text: status.packets_sent"></span>
              </p>
              <p><b>OpenEVSE</b></p>
              <p><b>RAPI packets:</b><br><span data-bind="text: status.comm_success"></span> of <span data-bind="text: status.comm_sent"></span></p>
            </div>

            <div id="client-view" data-bind="visible: !wifi.canConfigure() &amp;&amp; !wifi.wifiConnecting() &amp;&amp; !status.isWired()">
              <table>
                <tr>
                  <th>Network</th>
                  <th>RSSI dBm</th>
                </tr>
                <tbody id="sta-ssid">
                  <tr data-bind="click: function () { wifi.forceConfig(true); }">
                    <td data-bind="text: config.ssid"></td>
                    <td data-bind="text: status.srssi"></td>
                  </tr>
                </tbody>
              </table>
              <button data-bind="click: function () { wifi.forceConfig(true); }">Change WiFi network</button>
              <p><b>IP Address:</b><br><a data-bind="text: status.ipaddress, attr: {href: 'http://'+status.ipaddress()}"></a></p>
              <p>
                <b>Successful packets:</b><br>
                <span data-bind="text: status.packets_success"></span> of <span data-bind="text: status.packets_sent"></span>
              </p>
              <p><b>OpenEVSE</b></p>
              <p><b>RAPI packets:</b><br><span data-bind="text: status.comm_success"></span> of <span data-bind="text: status.comm_sent"></span></p>
              <button id="apoff" data-bind="visible: status.isWifiAccessPoint, click: wifi.turnOffAccessPoint, disable: wifi.turnOffAccessPointFetching">Turn off Access Point</button>
            </div>

            <div id="ap-view" data-bind="visible: wifi.canConfigure() &amp;&amp; !wifi.wifiConnecting() &amp;&amp; !status.isWired()">
              <p>Connect to network:</p>

              <div id="wifiList">
                <ul class="list-group" data-bind="foreach: scan.filteredResults, visible: 0 != scan.results().length">
                  <li class="list-group-item" data-bind="click: $root.wifi.select, css: { active: $root.wifi.selectedNet() === $data }">
                    <span  data-bind="text: ssid"></span>
                    <img width="24px" height="24px" data-bind="attr:{src: 'wifi_signal_'+strength()+'.svg'}" />
                  </li>
                </ul>
              </div>

              <div data-bind="visible: 0 == scan.results().length">
                Scanning...
              </div>

              <p>
                <b>SSID:</b><br>
                <input type="text" autocapitalize="none" data-bind="textInput: config.ssid">
              </p>
              <p>
                <b>Passkey:</b><br>
                <input type="text" autocapitalize="none" data-bind="textInput: wifiPassword.value, attr: { type: wifiPassword.show() ? 'text' : 'password' }"><br/>
                <div>
                  <input id="wifipassword" type="checkbox" data-bind="checked: wifiPassword.show" />
                  <label for="wifipassword">Show password</label>
                </div>
              </p>
              <p>
                <button data-bind="click: wifi.saveNetwork, text: (wifi.saveNetworkFetching() ? 'Saving' : (wifi.saveNetworkSuccess() ? 'Saved' : 'Connect')), disable: wifi.saveNetworkFetching">Connect</button>
              </p>
            </div>

            <div data-bind="visible: wifi.wifiConnecting">
              <p>Connecting to WIFI Network...</p>
            </div>
          </div>

          <div class="box380 right">
            <h2>Administration</h2>
            <p>
              <b>Username:</b><br>
              <input type="text" autocapitalize="none" data-bind="textInput: config.www_username" pattern=".{15}" title="The field requires 15 characters" maxlength="15" required="">
              <span class="small-text validMessage">15 characters max</span>
            </p>
            <p>
              <b>Password:</b><br>
              <input type="password" autocapitalize="none" data-bind="textInput: wwwPassword.value, attr: { type: wwwPassword.show() ? 'text' : 'password' }" pattern=".{15}" title="The field requires 15 characters" maxlength="15" required="" /><br />
              <span>
                <input id="wwwPassword" type="checkbox" data-bind="checked: wwwPassword.show" />
                <label for="wwwPassword">Show password</label>
              </span><br />
              <span class="small-text validMessage">15 characters max</span><br>
              <span class="small-text">Web interface HTTP authentication.</span><br><br>
              <button data-bind="click: saveAdmin, text: (saveAdminFetching() ? 'Saving' : (saveAdminSuccess() ? 'Saved' : 'Save')), disable: saveAdminFetching">Save</button>
            </p>
          </div>

          <div class="box380 right">
            <h2>WiFi Firmware</h2>
            <p><b>Version: </b><span data-bind="text: config.version"></span></p>
            <div data-bind="visible: !updateFetching() && !updateComplete()">
              <form action="#" method="post" enctype="multipart/form-data" id="upload_form" data-bind="submit: otaUpdate">
                <input type="file" name="update" data-bind="value: updateFilename">
                <button data-bind="click: otaUpdate, text: (updateFetching() ? 'Updating...' : 'Update'), disable: ('' == updateFilename())">Update</button>
              </form>
            </div>
            <div data-bind="visible: (updateError() !== '')" class="box error">
              <h4>Error:</h4>
              <span data-bind="text: updateError"></span>
            </div>
            <div data-bind="visible: updateFetching() && !updateComplete()">
              Updating... <br/>
              <div id="progressBack">
                <div id="progressBar" data-bind="style: { width: updateProgress()+'%' }"></div>
              </div>
            </div>
            <div  data-bind="visible: updateComplete">
              Firmware update completed ok
            </div>
            <p>
              <button data-bind="click: restart, text: (restartFetching() ? 'Restarting...' : 'Restart'), disable: restartFetching">Restart</button>
              <button data-bind="click: factoryReset, text: (factoryResetFetching() ? 'Resetting...' : 'Factory Reset'), disable: factoryResetFetching">Factory Reset</button>
            </p>
          </div>

          <div class="box380 left" data-bind="visible: advancedMode()">
            <h2>Advanced Settings</h2>
            <p data-bind="visible: false !== config.hostname()">
              <b>Hostname:</b><br>
              <input type="text" autocapitalize="none" data-bind="textInput: config.hostname" pattern=".{31}" title="The field max 31 characters" maxlength="31" required="">
              <span class="small-text validMessage">31 characters max</span>
            </p>
            <p data-bind="visible: false !== config.sntp_hostname()">
              <b>NTP Server:</b><br>
              <input type="text" autocapitalize="none" data-bind="textInput: config.sntp_hostname" pattern=".{31}">
            </p>
            <p>
              <button data-bind="click: advancedGroup.save, text: (advancedGroup.fetching() ? 'Saving' : (advancedGroup.success() ? 'Saved' : 'Save')), disable: advancedGroup.fetching">Save</button>
            </p>
          </div>

          <div class="box380 right">
            <h2>RFID</h2>
            <b>Enabled: </b>
            <label class="switch">
              <input type="checkbox" id="rfid_enabled" data-bind="checked: config.rfid_enabled" />
              <div class="slider round"></div>
            </label>
            <br>
            <div data-bind="visible: config.rfid_storage() != ''">
              <h3>Registered tags</h3>
              <div id="stored_tags_list">
                <ul class="list-group" data-bind="foreach: config.rfid_storage().split(',')">
                  <li class="list-group-item" data-bind="visible: $data">
                    <span data-bind="text: $data" style="font-family: 'Courier New', monospace;"></span>
                    <span style="float: right"><a style="cursor: pointer;" data-bind="click: $parent.removeRFIDTag">Remove</a></span>
                  </li>
                </ul>
              </div>
              <button data-bind="click: clearRFIDTags">Clear tags</button>
            </div>
            <div>
              <!--b>UID:</b><br>
              <input style="float: left" type="text" autocapitalize="none" data-bind="textInput: config.sntp_hostname"><br>
              <button onclick="window.open('term.html?debug');">Add</button-->
              <div data-bind="visible: config.rfid_enabled">
                <h3>Manage scanned tag</h3>
                <button data-bind="click: waitForRFID, disable: rfid.waiting() > 0">Scan</button>
                <div data-bind="visible: rfid.waiting() > 0">
                  <b>Place your RFID tag on the scanner... <span data-bind="text: rfid.timeLeft"></span></b>
                </div>
                <div data-bind="visible: rfid.scanned()">
                  <b>Tag scanned successfully!</b>
                  <h3>UID: <span data-bind="text: rfid.scanned"></span></h3>
                  <div>
                    <span data-bind="text: config.rfid_storage().split(',').includes(rfid.scanned()) ? 'The tag is already registered' : 'The tag is not registered'"></span><br>
                    <button data-bind="visible: !config.rfid_storage().split(',').includes(rfid.scanned()), click: function(data, event) { addRFIDTag(rfid.scanned()) }">Register tag</button>
                    <button data-bind="visible:  config.rfid_storage().split(',').includes(rfid.scanned()), click: function(data, event) { removeRFIDTag(rfid.scanned()) }">Remove tag</button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="box380 left">
            <h2>Developer Mode</h2>
            <div>
              <b>Enabled: </b>
              <label class="switch">
                <input type="checkbox" data-bind="checked: developerMode">
                <div class="slider round"></div>
              </label>
            </div>
            <h3>Serial Consoles</h3>
            <div>
              <button onclick="window.open('term.html?debug');">Debug</button>
              <button onclick="window.open('term.html?evse');">OpenEVSE</button>
            </div>
          </div>
        </div>
        <!--end content 1-->

        <!--TAB 2: Services -->
        <div id="content-2" data-bind="visible: isServices">
          <div class="box380 left">
            <h2>Energy Monitoring <img src="data:image/png;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" data-src="emoncms.jpg" align="left" /></h2>
            <p>
              <input type="checkbox" id="emoncms_enabled" data-bind="checked: config.emoncms_enabled" />
              <label for="emoncms_enabled"><b>Enable Emoncms</b></label>
            </p>
            <div data-bind="visible: config.emoncms_enabled">
              <div><b>Emoncms Server*:</b></div>
              <div data-bind="css: { protocol: config.http_supported_protocols().length > 0 }">
                <select data-bind="visible: config.http_supported_protocols().length > 0,
                  options: config.http_supported_protocols,
                  optionsText: function(item) {
                    return item + '://'
                  },
                  value: emoncms_protocol"></select>
                <input type="text" autocapitalize="none" data-bind="textInput: emoncms_server">
              </div>
              <div class="small-text">e.g:
                <a href="https://data.openevse.com/emoncms">data.openevse.com/emoncms</a>,
                <a href="https://emoncms.org">emoncms.org</a>,
                <a href="http://emonpi/emoncms">emonpi/emoncms</a>
              </div>
            </div>
            <p data-bind="visible: config.emoncms_enabled">
              <b>Emoncms Node*:</b><br>
              <input type="text" autocapitalize="none" data-bind="textInput: config.emoncms_node">
            </p>
            <p data-bind="visible: config.emoncms_enabled">
              <b>Emoncms write-apikey*:</b><br />
              <input type="password" autocapitalize="none" data-bind="textInput: emoncmsApiKey.value, attr: { type: emoncmsApiKey.show() ? 'text' : 'password' }" /><br />
              <span>
                <input id="emoncmsApiKey" type="checkbox" data-bind="checked: emoncmsApiKey.show" />
                <label for="emoncmsApiKey">Show password</label>
              </span>
            </p>
            <p data-bind="visible: config.emoncms_enabled && config.http_supported_protocols().length === 0">
              <b>Emoncms SSL SHA-1 Fingerprint (optional):</b><br>
              <input type="text" autocapitalize="none" data-bind="textInput: config.emoncms_fingerprint"><br>
              <br><span class="small-text">HTTPS will be enabled if present e.g:</span>
              <span class="small-text">
                7D:82:15:BE:D7:BC:72:58:87:7D:8E:40:D4:80:BA:1A:9F:8B:8D:DA
              </span>
            </p>
            <p>
              <button data-bind="click: saveEmonCms, text: (saveEmonCmsFetching() ? 'Saving' : (saveEmonCmsSuccess() ? 'Saved' : 'Save')), disable: saveEmonCmsFetching">Save</button>
            </p>
            <p>
              <span data-bind="visible: config.emoncms_enabled"><b>&nbsp; Connected:&nbsp;<span data-bind="text: 1 === status.emoncms_connected() ? 'Yes' : 'No'"></span></b></span>
              <span data-bind="visible: config.emoncms_enabled() &amp;&amp; 1 === status.emoncms_connected()"><b>&nbsp; Successful posts:&nbsp;<span data-bind="text: status.packets_success"></span></b></span>
            </p>
            <p data-bind="visible: config.emoncms_enabled() &amp;&amp; 0 === status.emoncms_connected() &amp;&amp; false !== status.emoncms_message(), text: status.emoncms_message"></p>
          </div>

          <div class="box380 right">
            <h2>MQTT</h2>
            <p>
              <input type="checkbox" id="mqtt_enabled" data-bind="checked: config.mqtt_enabled" />
              <label for="mqtt_enabled"><b>Enable MQTT</b></label>
              <span class="info" data-bind="click: toggle.bind($data, showMqttInfo)"></span>
            </p>
            <div class="box" data-bind="visible: showMqttInfo">
              <div>
                Status published to:<br/>
                <span class="small-text">{base-topic}/{status} value</span><br>
                <span class="small-text">e.g. <span data-bind="text: '' !== config.mqtt_topic() ? config.mqtt_topic() : 'openevse'"></span>/amp 16</span><br>
              </div>
              <p>
                RAPI control subscribes to:<br/>
                <span class="small-text">{base-topic}/rapi/in/{command} value</span><br>
                <span class="small-text">e.g. <span data-bind="text: '' !== config.mqtt_topic() ? config.mqtt_topic() : 'openevse'"></span>/rapi/in/$SC 16</span><br>
                <span class="small-text">e.g. <span data-bind="text: '' !== config.mqtt_topic() ? config.mqtt_topic() : 'openevse'"></span>/rapi/in/$GC</span><br>
              </p>
              <p>
                RAPI response published to:<br/>
                <span class="small-text">{base-topic}/rapi/out response</span><br>
                <span class="small-text">e.g. <span data-bind="text: '' !== config.mqtt_topic() ? config.mqtt_topic() : 'openevse'"></span>/rapi/out $OK 6 32</span><br>
              </p>
            </div>
            <div data-bind="visible: config.mqtt_enabled">
              <b>Host*:</b><br>
              <div data-bind="css: { protocol: config.mqtt_supported_protocols().length > 0 }">
                <select data-bind="visible: config.mqtt_protocol_enable,
                                    options: config.mqtt_supported_protocols,
                                    optionsText: function(item) {
                                      return item + '://'
                                    },
                                    value: config.mqtt_protocol"></select>
                <input data-bind="textInput: config.mqtt_server" type="text" autocapitalize="none"><br/>
                <span class="small-text">e.g 'emonpi', 'test.mosquitto.org', '192.168.1.4'</span>
              </div>
            </div>
            <p data-bind="visible: config.mqtt_enabled() &amp;&amp; config.mqtt_port_enable()">
              <b>Port*:</b><br>
              <input data-bind="textInput: config.mqtt_port" type="number" min="0" max="65535" autocapitalize="none"><br/>
            </p>
            <div data-bind="visible: config.mqtt_enabled() &amp;&amp; config.mqtt_reject_unauthorized_enable() &amp;&amp; advancedMode()">
              <b>Reject self-signed certificates:</b>
              <label class="switch">
                <input type="checkbox" data-bind="checked: config.mqtt_reject_unauthorized" />
                <div class="slider round"></div>
              </label>
            </div>
            <div data-bind="visible: config.mqtt_enabled() &amp;&amp; !config.mqtt_reject_unauthorized()" class="box warning" style="margin-top: 20px;">
              <h4>Warning!!</h4>
              Certificate validation is disabled, although the connection to MQTT server will be encrypted the connection is still
              vulnerable to man-in-the-middle attacks.
            </div>
            <p data-bind="visible: config.mqtt_enabled">
              <b>Username:</b><span> blank - no authentication</span>
              <input data-bind="textInput: config.mqtt_user" type="text" autocapitalize="none">
            </p>
            <p data-bind="visible: config.mqtt_enabled">
              <b>Password:</b><span> blank - no authentication</span>
              <input type="password" autocapitalize="none" data-bind="textInput: mqttPassword.value, attr: { type: mqttPassword.show() ? 'text' : 'password' }" /><br />
              <span>
                <input id="mqttPassword" type="checkbox" data-bind="checked: mqttPassword.show" />
                <label for="mqttPassword">Show password</label>
              </span>
            </p>
            <p data-bind="visible: config.mqtt_enabled">
              <b>Base-topic*:</b><br>
              <input data-bind="textInput: config.mqtt_topic" type="text" autocapitalize="none"><br/>
              <span class="small-text">e.g 'openevse'</span>
            </p>
            <p data-bind="visible: config.mqtt_enabled">
              <b>Voltage topic:</b>
              <input data-bind="textInput: config.mqtt_vrms" type="text" autocapitalize="none" hint="emon/emonpi/vrms"><br>
              <span class="small-text">Voltage MQTT topic to improve power calculations</span>
            </p>
            <p>
              <button data-bind="click: mqttGroup.save, text: (mqttGroup.fetching() ? 'Saving' : (mqttGroup.success() ? 'Saved' : 'Save')), disable: mqttGroup.fetching">Save</button>
              <span data-bind="visible: config.mqtt_enabled"><b>&nbsp; Connected:&nbsp;<span data-bind="text: 1 === status.mqtt_connected() ? 'Yes' : 'No'"></span></b></span>
            </p>
          </div>

          <div class="box380 left">
            <h2>OhmConnect <img src="data:image/png;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" data-src="ohm.jpg" align=left></h2>
            <p>
              <input type="checkbox" id="ohm_enabled" data-bind="checked: config.ohm_enabled" />
              <label for="ohm_enabled"><b>Enable OhmConnect</b></label>
              <a href="https://ohm.co/openevse" rel="nofollow">Click Here to Join</a>
            </p>
            <p data-bind="visible: config.ohm_enabled">
              OhmConnect monitors real-time conditions on the electricity grid. When dirty and unsustainable power plants turn
              on, our users receive a notification to save energy.
            </p>
            <p data-bind="visible: config.ohm_enabled">
              <b>Ohm Hour:</b> <span data-bind="text: status.ohm_hour"></span>
            </p>
            <p data-bind="visible: config.ohm_enabled">
              <b>Ohm key:</b><br>
              <input data-bind="textInput: config.ohmkey" type="text" autocapitalize="none">
            </p>
            <p data-bind="visible: config.ohm_enabled">
              <strong>USA - California only</strong>
            </p>
            <p data-bind="visible: config.ohm_enabled">
              Ohm Key can be obtained by logging in to OhmConnect, enter Settings and locate the link in "Open Source Projects".<br/>
              Example: https://login.ohmconnect.com/verify-ohm-hour/OpnEoVse<br/>
              <b>Key: </b>OpnEoVse
            </p>
            <p>
              <button data-bind="click: saveOhmKey, text: (saveOhmKeyFetching() ? 'Saving' : (saveOhmKeySuccess() ? 'Saved' : 'Save')), disable: saveOhmKeyFetching">Save</button>
            </p>
          </div>

          <!-- Divert Mode -->
          <div class="box380 right">
            <h2>Solar PV divert</h2>

            <p data-bind="visible: config.mqtt_enabled">
              <input type="checkbox" id="divert_enabled" data-bind="checked: config.divert_enabled" />
              <label for="divert_enabled"><b>Enable Solar PV Divert</b></label>
              <span class="info" data-bind="click: toggle.bind($data, showSolarDivert)"></span>
            </p>

            <div class="box error" data-bind="visible: !config.mqtt_enabled()">
              <h4>MQTT not enabled.</h4>
              Solar PV Divert requires an SolarPV-gen or Grid (+I/-E) feed to be delivered via MQTT.
            </div>

            <div class="box" data-bind="visible: showSolarDivert()">
              <div>Dynamically adjust charge rate based on solar PV generation or excess power (grid export).</div>
              <p>
                <ul>
                  <li><span class="small-text">If only solar PV feed available: charge rate is modulated based on <b>solar PV generation.</b></span></li>
                  <li><span class="small-text">If grid +I/-E (positive Import / negative Export) feed is available: charge rate will be modulated by available  <b>excess power.</b></span></li>
                  <li><span class="small-text">If EVSE is sleeping: charging will begin when solar PV / excess power > min charge rate.</span></li>
                  <li><span class="small-text">Charging will pause if the excess power drops below the min charge rate for a period of time.</span></li>
                </ul>
                <span class="small-text"><i>Note: It's assumed that EVSE power is included in the grid feed</i></span><br>
              </p>
            </div>

            <p data-bind="visible: config.divert_enabled() &amp;&amp; config.mqtt_enabled()">
              <br>
              <span data-bind="visible: divertFeedType() === 'solar'"><b>Solar:</b></span>
              <span data-bind="visible: divertFeedType() === 'grid_ie'"><b>Grid Import/Export:</b></span>
              <span data-bind="text: divertFeedType() === 'grid_ie' ? status.grid_ie() : status.solar()"></span>W -
              <span data-bind="text: formatUpdate(openevse.time.divert_update()), css: updateClass(openevse.time.divert_update())"></span>
              <span data-bind="visible: ecoMode"> | <b>Charge rate:</b> <span data-bind="text: status.charge_rate"></span>A</span>
            </p>

            <div data-bind="visible: config.divert_enabled() &amp;&amp; config.mqtt_enabled()">
              <b>Feed*:</b><br>
              <div class="divert">
                <select data-bind="value: divertFeedType">
                  <option value="solar">SolarPV-gen</option>
                  <option value="grid_ie">Grid (+I/-E)</option>
                </select>
                <input data-bind="textInput: divertFeedValue" type="text" autocapitalize="none"><br/>
                <span data-bind="visible: divertFeedType() === 'solar'" class="small-text">Solar PV MQTT topic to modulate charge rate based on solar</span>
                <span data-bind="visible: divertFeedType() === 'grid_ie'" class="small-text">Grid (+I/-E) MQTT topic to modulate charge rate based on <b>excess power</b></span>
              </div>
            </div>

            <p data-bind="visible: advancedMode() &amp;&amp; config.divert_enabled() &amp;&amp; config.mqtt_enabled() &amp;&amp; divertFeedType() === 'grid_ie'">
              <b>Required PV power ratio:</b><br>
              <input data-bind="textInput: config.divert_PV_ratio" type="number" autocapitalize="none" hint="1.1" min="0.05" max="1.5" step="0.01"><br>
              <span class="small-text">The fraction of PV current that suffices to start charging or increment current </span>
            </p>

            <p data-bind="visible: advancedMode() &amp;&amp; config.divert_enabled() &amp;&amp; config.mqtt_enabled()">
              <b>Divert smoothing attack:</b><br>
              <input data-bind="textInput: config.divert_attack_smoothing_factor" type="number" autocapitalize="none" hint="0.4" min="0" max="1" step="0.01"><br>
              <span class="small-text">The amount of the new feed value to add to the divert available power rolling average </span>
            </p>

            <p data-bind="visible: advancedMode() &amp;&amp; config.divert_enabled() &amp;&amp; config.mqtt_enabled()">
              <b>Divert smoothing decay:</b><br>
              <input data-bind="textInput: config.divert_decay_smoothing_factor" type="number" autocapitalize="none" hint="0.05" min="0" max="1" step="0.01"><br>
              <span class="small-text">The amount of the new feed value to remove to the divert available power rolling average </span>
            </p>

            <p data-bind="visible: advancedMode() &amp;&amp; config.divert_enabled() &amp;&amp; config.mqtt_enabled()">
              <b>Minimum charge time:</b><br>
              <input data-bind="textInput: config.divert_min_charge_time" type="number" autocapitalize="none" hint="600" min="0" max="100000" step="10"><br>
              <span class="small-text">The minimum amount of time (seconds) to charge the car once enabled via the Solar PV divert. This can help minimise wear and tear on the EVSE.</span>
            </p>

            <p data-bind="visible: isEcoModeAvailable">
              <button data-bind="click: divertGroup.save, text: (divertGroup.fetching() ? 'Saving' : (divertGroup.success() ? 'Saved' : 'Save')), disable: divertGroup.fetching">Save</button>
            </p>
          </div>

          <div class="box380 left">
            <h2>OCPP 1.6<img src="data:image/png;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" data-src="arduinoocpp.png" align=left></h2>
            <p>
              <input type="checkbox" id="ocpp_enabled" data-bind="checked: config.ocpp_enabled" />
              <label for="ocpp_enabled"><b>Enable OCPP</b></label>
            </p>
            <div data-bind="visible: config.ocpp_enabled">
              <b>Central System URL*:</b><br>
              <input data-bind="textInput: config.ocpp_server" type="text" autocapitalize="none"><br/>
              <span class="small-text">e.g 'wss://ocpp.my-cpms.com/steve/websocket/CentralSystemService'</span>
            </div>
            <p data-bind="visible: config.ocpp_enabled">
              <b>Charge box ID*:</b>
              <input data-bind="textInput: config.ocpp_chargeBoxId" type="text" autocapitalize="none">
            </p>
            <p data-bind="visible: config.ocpp_enabled">
              <b>ID Tag*:</b>
              <input data-bind="textInput: config.ocpp_idTag" type="text" autocapitalize="none">
            </p>
            <p data-bind="visible: config.ocpp_enabled">
              <b>Transaction start point:</b><br>
              <select data-bind="visible: config.ocpp_enabled,
                                    options: config.supported_tx_start_points,
                                    optionsText: function(item) {
                                      if (item === 'tx_pending') {return 'StartTransaction pending';} else if (item === 'tx_accepted') {return 'StartTransaction accepted';} else {return 'only RemoteStartTransaction';}
                                    },
                                    value: config.tx_start_point"></select>
            </p>
            <p data-bind="visible: config.ocpp_enabled">
              <b>Access control:</b><br>
              <span>
                <input id="ocpp_suspend_evse" type="checkbox" data-bind="checked: config.ocpp_suspend_evse" />
                <label for="ocpp_suspend_evse">OCPP can suspend EVSE</label>
              </span><br>
              <span>
                <input id="ocpp_energize_plug" type="checkbox" data-bind="checked: config.ocpp_energize_plug" />
                <label for="ocpp_energize_plug">OCPP can energize plug</label>
              </span>
            </p>
            <p>
              <button data-bind="click: ocppGroup.save, text: (ocppGroup.fetching() ? 'Saving' : (ocppGroup.success() ? 'Saved' : 'Save')), disable: ocppGroup.fetching">Save</button>
              <span data-bind="visible: config.ocpp_enabled"><b>&nbsp; Connected:&nbsp;<span data-bind="text: 1 === status.ocpp_connected() ? 'Yes' : 'No'"></span></b></span>
            </p>
          </div>
        </div>
        <!--end TAB 2-->

        <!--TAB 3: OpenEVSE -->
        <div id="content-3" data-bind="visible: isStatus">

          <!-- Session Status -->
          <div data-bind="visible: status.isError" class="box box-full left error">
            <h4>EVSE Error</h4>
            <span data-bind="text: status.estate"></span>
          </div>

          <div data-bind="visible: !status.evse_connected()" class="box box-full left error">
            <h4>EVSE Error</h4>
            <span>OpenEVSE not responding or not connected</span>
          </div>

          <div data-bind="visible: !status.isError() &amp;&amp; status.evse_connected(),
                          css: { ready: status.isReady(),
                                 connected: status.isConnected() &amp;&amp; !status.isCharging(),
                                 charging: status.isCharging(),
                                 sleeping: status.isPaused() &amp;&amp; 0 == status.vehicle(),
                                 sleeping_connected: status.isPaused() &amp;&amp; 1 == status.vehicle() }"
               class="box box-full left">
            <h2 class="left">Status</h2>
            <h2 class="right" data-bind="text: status.estate"></h2>

            <table>
              <tr>
                <th>Current</th>
                <th>Energy</th>
                <th>Temp</th>
                <th>Elapsed</th>
              </tr>
              <tr>
                <td><span data-bind="text: scaleString(status.amp(), 1000, 2) + ' A'"></span></td>
                <td><span data-bind="text: scaleString(status.session_energy(), 1000, 2) + ' kWh'"></span></td>
                <td><span data-bind="text: scaleString(status.temp(), 10, 1) + ' &deg;C'"></span></td>
                <td><span data-bind="text: openevse.time.elapsed"></span></td>
              </tr>
            </table>

            <div data-bind="visible: ecoMode() &amp;&amp; isEcoModeAvailable()">
              <br>
              <span data-bind="visible: haveSolar"><b>Solar:</b></span>
              <span data-bind="visible: haveGridIe"><b>Grid Import/Export:</b></span>
              <span data-bind="text: haveGridIe() ? status.grid_ie() : status.solar()"></span>W -
              <span data-bind="text: formatUpdate(openevse.time.divert_update()), css: updateClass(openevse.time.divert_update())"></span>
              |
              <span data-bind="visible: status.isReady()"><b>Vehicle not connected</b></span>
              <span data-bind="visible: status.isSleeping() || (status.isConnected() &amp;&amp; !status.isCharging())"><b>Waiting for solar</b></span>
              <span data-bind="visible: status.isCharging()"><b>Charging from solar</b></span>
              <!--span data-bind="visible: status.isCharging()"><b>Fast charging</b></span-->
              <span data-bind="visible: status.isCharging()">
                | <b>Charge rate:</b> <span data-bind="text: status.charge_rate"></span>A
              </span>
              <span data-bind="visible: advancedMode">
                <br/>
                <b>Voltage:</b> <span data-bind="text: parseFloat(status.voltage()).toFixed(1)"></span>V
                <span data-bind="visible: status.available_current() !== false">| <b>Available Current:</b> <span data-bind="text: parseFloat(status.available_current()).toFixed(2)"></span>A</span>
                <span data-bind="visible: status.smoothed_available_current() !== false">| <b>Smoothed Current:</b> <span data-bind="text: parseFloat(status.smoothed_available_current()).toFixed(2)"></span>A</span>
              </span>
            </div>
          </div>

          <!-- Session Options -->
          <div class="box380 left" data-bind="visible: status.evse_connected">
            <h2>Charge Options</h2>

            <div data-bind="visible: isEcoModeAvailable">
              <span data-bind="css: {selected: !ecoMode() }">Normal (fast)</span>
              <label class="switch">
                <input type="checkbox" data-bind="checked: ecoMode" />
                <div class="slider round"></div>
              </label>
              <span data-bind="css: {selected: ecoMode }">Eco (PV divert)</span><br/>
            </div>

            <p data-bind="visible: !status.isError() &amp;&amp; !ecoMode()">
              <h3 data-bind="visible: status.manual_override">Manual Override</h3>
              <button data-bind="click: setOverride,
                                 enable: !setOverrideFetching(),
                                 visible: !status.manual_override(),
                                 text: status.isPaused() ? 'Start' : 'Pause'">Start</button>
              <button data-bind="click: clearOverride,
                                 enable: !clearOverrideFetching(),
                                 visible: status.manual_override()">Clear</button>
            </p>

            <span data-bind="visible: !status.isError() &amp;&amp; !ecoMode()">
              <hr \>
              <p>
                <b>Time limit:</b><br\>
                <select data-bind="options: openevse.timeLimits,
                                   optionsText: 'name',
                                   optionsValue: 'value',
                                   value: openevse.timeLimit,
                                   enable: !openevse.updatingTimeLimit() &amp;&amp; status.isConnected(),
                                   css: { saved: openevse.savedTimeLimit }"></select>
              </p>

              <p>
                <b>Energy limit:</b><br\>
                <select data-bind="options: openevse.chargeLimits,
                                   optionsText: 'name',
                                   optionsValue: 'value',
                                   value: openevse.chargeLimit,
                                   enable: !openevse.updatingChargeLimit() &amp;&amp; status.isConnected(),
                                   css: { saved: openevse.savedChargeLimit }" ></select>
              </p>
            </span>

            <hr> <br>
            <div data-bind="with: schedule">
              <b>Timer:</b><br>
                Start: <input type="time" data-bind="value: delayTimerStart, disable: $root.status.isError" />
                &nbsp;&nbsp;
                Stop: <input type="time" data-bind="value: delayTimerStop, disable: $root.status.isError" /><br/>
                <br>
                <button data-bind="text: delayTimerEnabled() ? 'Update' : 'Set',
                                   enable: !updatingDelayTimer() &amp;&amp;
                                           delayTimerValid() &amp;&amp;
                                           !$root.status.isError(),
                                   click: startDelayTimer">Set</button>
                <button data-bind="visible: delayTimerEnabled(),
                                   enable: !updatingDelayTimer() &amp;&amp;
                                           !$root.status.isError(),
                                   click: stopDelayTimer">Cancel</button>
            </div>
          </div>

          <!-- Energy -->
          <div class="box380 right" data-bind="visible: advancedMode() &amp;&amp; status.evse_connected()">
            <h2>Energy</h2>
            <table>
              <tr>
                <th>Energy</th>
                <th></th>
              </tr>
              <tr>
                <td>This Session:</td>
                <td><span data-bind="text: scaleString(status.session_energy(), 1000, 2)+ ' kWh'"></span></td>
              </tr>
              <tr>
                <td>Total:</td>
                <td><span data-bind="text: scaleString(status.total_energy(), 1, 2)+ ' kWh'"></span></td>
              </tr>
            </table>
          </div>

          <!-- Sensor Values -->
          <div class="box380 right" data-bind="visible: advancedMode() &amp;&amp; status.evse_connected()">
            <h2>Sensor Values</h2>
            <table>
              <tr>
                <th>Sensor</th>
                <th>Value</th>
              </tr>
              <tr>
                <td>Pilot:</td>
                <td><span data-bind="text: status.pilot() + ' A'"></span></td>
              </tr>
              <tr>
                <td>Current Now:</td>
                <td><span data-bind="text: scaleString(status.amp(), 1000, 2) + ' A'"></span></td>
              </tr>
              <tr data-bind="visible: false !== status.voltage()">
                <td>Voltage:</td>
                <td><span data-bind="text: scaleString(status.voltage(), 1, 2) + ' V'"></span></td>
              </tr>
              <tr data-bind="visible: false !== status.temp1()">
                <td>Temp1:</td>
                <td><span data-bind="text: scaleString(status.temp1(), 10, 1) + ' &deg;C'"></span></td>
              </tr>
              <tr data-bind="visible: false !== status.temp2()">
                <td>Temp2:</td>
                <td><span data-bind="text: scaleString(status.temp2(), 10, 1) + ' &deg;C'"></span></td>
              </tr>
              <tr data-bind="visible: false !== status.temp3()">
                <td>Temp3:</td>
                <td><span data-bind="text: scaleString(status.temp3(), 10, 1) + ' &deg;C'"></span></td>
              </tr>
              <tr data-bind="visible: false !== status.temp4()">
                <td>Temp4:</td>
                <td><span data-bind="text: scaleString(status.temp4(), 10, 1) + ' &deg;C'"></span></td>
              </tr>
            </table>
          </div>

          <!-- Settings -->
          <div class="box380 setup" data-bind="visible: status.evse_connected, css: { right: !advancedMode(), left: advancedMode() }">
            <h2>Setup</h2>
            <p data-bind="visible: !openevse.time.hasRTC()">
              <b>Time: No RTC detected</b>
            </p>
            <p data-bind="with: openevse.time, visible: openevse.time.hasRTC()">
              <b>Time:</b><br/>
              <input type="date" data-bind="value: date, disable: automaticTime" />
              <input type="time" data-bind="value: time, disable: automaticTime" /><br/>
            </p>
            <p data-bind="visible: openevse.time.hasRTC() && false !== config.time_zone() && 'ntp' === timeSource()">
              <b>Time zone:</b><br/>
              <select data-bind="options: zones.zones,
                        optionsText: 'name',
                        optionsValue: 'value',
                        value: time_zone"></select>
            </p>
            <div data-bind="visible: openevse.time.hasRTC()">
              Set time from
              <select data-bind="value: timeSource" style="width: 100px">
                <option value="manual">Manual</option>
                <option value="browser">Browser</option>
                <option value="ntp" data-bind="visible: false !== config.sntp_hostname()">NTP</option>
              </select>
              <button data-bind="click: setTime, text: (setTimeFetching() ? 'Saving' : (setTimeSuccess() ? 'Saved' : 'Set time')), disable: setTimeFetching">Set time</button>
            </div>
            <hr>
            <p>
              <b>Service Level:</b><br/>
              <select data-bind="options: openevse.serviceLevels,
                                 optionsText: 'name',
                                 optionsValue: 'value',
                                 value: config.service,
                                 disable: openEvseService.fetching,
                                 css: { saved: openEvseService.success }"></select>
            </p>

            <p>
              <b>Max Current:</b><br/>
              <select data-bind="options: openevse.currentLevels,
                                  optionsText: 'name',
                                  optionsValue: 'value',
                                  value: config.max_current_soft,
                                  disable: openEvseMaxCurrentSoft.fetching,
                                  css: { saved: openEvseMaxCurrentSoft.success }"></select>
            </p>
          </div>

          <!-- Current -->
          <div class="box380 right" data-bind="visible: advancedMode() &amp;&amp; status.evse_connected()">
            <h2>Current</h2>
            <table>
              <tr>
                <th>Name</th>
                <th>
                </th>
              </tr>
              <tr>
                <td>Service Level:</td>
                <td>
                  <span data-bind="text: status.service_level"></span>
                </td>
              </tr>
              <tr>
                <td>Level <span data-bind="text: status.service_level"></span> Minimum:</td>
                <td>
                  <span data-bind="text: config.min_current_hard() + ' A'"></span>
                </td>
              </tr>
              <tr>
                <td>Level <span data-bind="text: status.service_level"></span> Maximum:</td>
                <td>
                  <span data-bind="text: config.max_current_hard() + ' A'"></span>
                </td>
              </tr>
              <tr>
                <td>Sensor Scale:</td>
                <td><span data-bind="text: config.scale"></span></td>
              </tr>
              <tr>
                <td>Sensor Offset:</td>
                <td><span data-bind="text: config.offset"></span></td>
              </tr>
            </table>
          </div>

          <!-- Safety -->
          <div class="box380 left" data-bind="visible: status.evse_connected() &amp;&amp; (advancedMode() || !config.all_tests_enabled())">
            <h2>Safety<span class="info" data-bind="click: toggle.bind($data, showSafety)"></span></h2>

            <div class="box" data-bind="visible: showSafety()">
              Hardware safety checks. Enable dev mode (System > Developer Mode) to enable/disable or use the physical LCD + menu button.
            </div>

            <div data-bind="visible: !config.all_tests_enabled()" class="box warning">
              <h4>Warning!!</h4>
              Not all the safety tests are enabled, please take extra care before charging your vehicle.
            </div>

            <table>
              <tr>
                <th>Test</th>
                <th>Status</th>
              </tr>
              <tr data-bind="css: {error: 9 === status.state() }">
                <td>GFI Self Test:</td>
                <td>
                  <label class="switch" data-bind="visible: developerMode">
                    <input type="checkbox" data-bind="checked: config.gfci_check" />
                    <div class="slider round"></div>
                  </label>
                  <span data-bind="text: config.gfci_check() ? 'Enabled' : 'Disabled'"></span>
                </td>
              </tr>
              <tr data-bind="css: {error: 7 === status.state() }">
                <td>Ground Monitoring:</td>
                <td>
                  <label class="switch" data-bind="visible: developerMode">
                    <input type="checkbox" data-bind="checked: config.ground_check" />
                    <div class="slider round"></div>
                  </label>
                  <span data-bind="text: config.ground_check() ? 'Enabled' : 'Disabled'"></span>
                </td>
              </tr>
              <tr data-bind="css: {error: 8 === status.state() }">
                <td>Stuck Contact Detection:</td>
                <td>
                  <label class="switch" data-bind="visible: developerMode">
                    <input type="checkbox" data-bind="checked: config.relay_check" />
                    <div class="slider round"></div>
                  </label>
                  <span data-bind="text: config.relay_check() ? 'Enabled' : 'Disabled'"></span>
                </td>
              </tr>
              <tr data-bind="css: {error: 10 === status.state() }">
                <td>Temperature Monitoring:</td>
                <td>
                  <label class="switch" data-bind="visible: developerMode">
                    <input type="checkbox" data-bind="checked: config.temp_check" />
                    <div class="slider round"></div>
                  </label>
                  <span data-bind="text: config.temp_check() ? 'Enabled' : 'Disabled'"></span>
                </td>
              </tr>
              <tr data-bind="css: {error: 5 === status.state() }">
                <td>Diode Check:</td>
                <td>
                  <label class="switch" data-bind="visible: developerMode">
                    <input type="checkbox" data-bind="checked: config.diode_check" />
                    <div class="slider round"></div>
                  </label>
                  <span data-bind="text: config.diode_check() ? 'Enabled' : 'Disabled'"></span>
                </td>
              </tr>
              <tr data-bind="css: {error: 4 === status.state() }">
                <td>Vent Required:</td>
                <td>
                  <label class="switch" data-bind="visible: developerMode">
                    <input type="checkbox" data-bind="checked: config.vent_check" />
                    <div class="slider round"></div>
                  </label>
                  <span data-bind="text: config.vent_check() ? 'Enabled' : 'Disabled'"></span>
                </td>
              </tr>
              <tr>
                <th>Error</th>
                <th>Count</th>
              </tr>
              <tr>
                <td>GFCI:</td>
                <td><span data-bind="text: status.gfcicount"></span></td>
              </tr>
              <tr>
                <td>No Ground:</td>
                <td><span data-bind="text: status.nogndcount"></span></td>
              </tr>
              <tr>
                <td>Stuck Contact:</td>
                <td><span data-bind="text: status.stuckcount"></span></td>
              </tr>
            </table>
          </div>

          <!-- Hardware -->
          <div class="box380 right" data-bind="visible: advancedMode() &amp;&amp; status.evse_connected()">
            <h2>Hardware</h2>
            <table>
              <tr>
                <th>OpenEVSE</th>
                <th></th>
              </tr>
              <tr>
                <td>Firmware:</td>
                <td><span data-bind="text: config.firmware"></span></td>
              </tr>
              <tr>
                <td colspan="2" data-bind="with: openevse">
                  <button data-bind="click: restart, text: (restartFetching() ? 'Restarting...' : 'Restart'), disable: restartFetching">Restart</button>
                </td>
              </tr>
              <tr>
                <th>OpenEVSE WiFi</th>
                <th></th>
              </tr>
              <tr data-bind="visible: false !== config.buildenv()">
                <td>Firmware config:</td>
                <td><span data-bind="text: config.buildenv"></span></td>
              </tr>
              <tr>
                <td>Firmware version:</td>
                <td><span data-bind="text: config.version"></span></td>
              </tr>
              <tr data-bind="visible: false !== config.espinfo()">
                <td>ESP info:</td>
                <td><span data-bind="text: config.espinfo"></span></td>
              </tr>
              <tr>
                <td>Flash Size:</td>
                <td><span data-bind="text: scaleString(config.espflash(), 1024, 0) + 'K'"></span></td>
              </tr>
              <tr>
                <td>Free RAM:</td>
                <td><span data-bind="text: scaleString(status.free_heap(), 1024, 0) + 'K'"></span></td>
              </tr>
              <tr>
                <td colspan="2">
                  <button data-bind="click: restart, text: (restartFetching() ? 'Restarting...' : 'Restart'), disable: restartFetching">Restart</button>
                </td>
              </tr>
            </table>
          </div>

          <div class="box380 right" data-bind="visible: advancedMode() &amp;&amp; status.evse_connected()">
            <h2>Vehicle Settings</h2>
            <h3>Pause status <span class="info" data-bind="click: toggle.bind($data, showVehiclePauseStatus)"></span></h3>
            <div class="box" data-bind="visible: showVehiclePauseStatus()">
              Some vehicles will shutdown if left in sleep mode (pilot signal enable) and then can not be woken up by timers/PV divert. Changing the
              pause state to disable should resolve this issue, however this removes the ability for the charger to detect if a vehicle is connected
              when paused.
            </div>
            <div>
              <span data-bind="css: {selected: !config.pause_uses_disabled() }">Sleep</span>
              <label class="switch">
                <input type="checkbox" data-bind="checked: config.pause_uses_disabled" />
                <div class="slider round"></div>
              </label>
              <span data-bind="css: {selected: config.pause_uses_disabled }">Disable</span><br/>
            </div>
          </div>

          <div class="box380" data-bind="visible: status.evse_connected,
                                         css: { right: !advancedMode() &amp;&amp; !config.all_tests_enabled(),
                                                left: advancedMode() || config.all_tests_enabled() }">
            <h2>Display</h2>
            <div>
              <span data-bind="css: {selected: !advancedMode() }">Simple</span>
              <label class="switch">
                <input type="checkbox" data-bind="checked: advancedMode" />
                <div class="slider round"></div>
              </label>
              <span data-bind="css: {selected: advancedMode }">Advanced</span><br/>
            </div>

            <hr/>

            <p data-bind="visible: config.led_brightness() !== false">
              <b>LED Brightness:</b><br\>
              <span class="rangeslidercontainer">
                <input type="range" min="0" max="255" class="rangeslider"
                       data-bind="value: config.led_brightness,
                                  disable: displayGroup.fetching(),
                                  css: { saved: displayGroup.success }">
              </span>
            </p>
            <!--p>
              <button data-bind="click: displayGroup.save,
                                 text: (displayGroup.fetching() ? 'Saving' :
                                       (displayGroup.success() ? 'Saved' : 'Save')),
                                 disable: displayGroup.fetching">Save</button>
            </p-->
          </div>

          <div class="box box-full left">
            <h2 class="left">History</h2>

            <table>
              <thead>
                <tr>
                  <th>Time</th>
                  <th>Type</th>
                  <th>Status</th>
                  <th>Energy</th>
                  <th>Temp</th>
                </tr>
              </thead>
              <tbody data-bind="foreach: logs.events">
                <tr>
                  <td><span data-bind="text: localTime"></span></td>
                  <td><span data-bind="text: type"></span></td>
                  <td><span data-bind="text: estate"></span></td>
                  <td><span data-bind="text: scaleString(energy(), 1000, 2) + ' kWh'"></span></td>
                  <td><span data-bind="text: scaleString(temperatureMax(), 1, 1) + ' &deg;C'"></span></td>
                </tr>
              </tbody>
              <tfoot data-bind="visible: logs.hasMore, disable: logs.fetchingBlock">
                <tr>
                  <td colspan="5" data-bind="click: logs.updateNext, clickBubble: false" style="text-align: center;">Load more</td>
                </tr>
              </tfoot>
            </table>
          </div>

        </div>
        <!--end tab 3-->

        <!--TAB 4: RAPI -->
        <div id="content-4" data-bind="visible: isRapi() &amp;&amp; status.evse_connected()">
          <div class="box box-full left">
            <form method='get' action='r' data-bind="with: rapi">
              <p>
                <b>RAPI Command:</b>
                <div data-bind="html: history"></div>
                <input type="text" autocapitalize="none" name='rapi' length='32' data-bind="textInput: cmd" />
              </p>
              <p>
                <button data-bind="click: send, disable: rapiSend">Send</button>
                <button data-bind="click: clear">Clear</button>
              </p>
            </form>
          </div>
          <div class="box box-full left">
            <h2>RAPI Get Commands</h2>
            <button data-bind="click: rapi.read, disable: rapi.reading">Read</button>
            <table data-bind="with: rapi">
              <thead>
                <tr>
                  <th>Get</th>
                  <th>Description</th>
                </tr>
              </thead>
              <tbody data-bind="foreach: get_commands">
                <tr>
                  <td data-bind="text: cmd"></td>
                  <td>
                    <span data-bind="html: description"></span><br/>
                    <dl data-bind="foreach: tokens">
                      <dt data-bind="text: name"></dt>
                      <dd data-bind="html: description"></dd>
                    </dl>
                    <div data-bind="visible: ret() != ''">
                      <span data-bind="text: ret, css: { error: ret().startsWith('$NK'), ok: ret().startsWith('$OK')}"></span><br/>
                      <div data-bind="foreach: tokens, visible: ret().startsWith('$OK')">
                        <span data-bind="text: name"></span> = <span data-bind="text: val"></span><br/>
                        <span data-bind="if: $data.hasOwnProperty('parsed')">
                          <ul data-bind="foreach: parsed">
                            <li>
                              <span data-bind="if: $data.hasOwnProperty('name')">
                                <span data-bind="text: name"></span> =
                              </span>
                              <span data-bind="text: val"></span>
                            </li>
                          </ul>
                        </span>
                      </div>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="box380 left">
            <h2>RAPI Set Commands</h2>
            <table>
              <tr>
                <th>Set</th>
                <th>Description</th>
              </tr>
              <tr>
                <td>$S0</td>
                <td>Set LCD Type, Monochrome (0), Color (1)</td>
              </tr>
              <tr>
                <td>$S1</td>
                <td>Set RTC, year month day hour minute second (all 2-digit max)</td>
              </tr>
              <tr>
                <td>$S2</td>
                <td>Enable (1)/ Disable (0) Ammeter Calibration Mode</td>
              </tr>
              <tr>
                <td>$S3</td>
                <td>Set Charge Time Limit, 15-minutes (1), 30-minutes (2), etc...</td>
              </tr>
              <tr>
                <td>$SA</td>
                <td>Set Ammeter Scale/Offset, scale offset</td>
              </tr>
              <tr>
                <td>$SC</td>
                <td>Set current capacity, integer</td>
              </tr>
              <tr>
                <td>$SH</td>
                <td>Set charge limit in kWh, integer</td>
              </tr>
              <tr>
                <td>$SK</td>
                <td>Set accumulated Wh, integer</td>
              </tr>
              <tr>
                  <td>$SL</td>
                  <td>Set service level (1/2/A)</td>
              </tr>
              <tr>
                <td>$SM</td>
                <td>Set Voltmeter Scale/Offset, scale offset</td>
              </tr>
              <tr>
                <td>$ST</td>
                <td>Set timer, start_hour start_min end_hour end_min</td>
              </tr>
              <tr>
                <td>$SV</td>
                <td>Set voltage for power calculations, millivolts</td>
              </tr>
            </table>
          </div>
          <div class="box380 right">
            <h2>RAPI System Functions</h2>
            <table>
              <tr>
                <th>Function</th>
                <th>Description</th>
              </tr>
              <tr>
                <td>$FB</td>
                <td>LCD Backlight Color (0-7)</td>
              </tr>
              <tr>
                <td>$FD</td>
                <td>Disable EVSE</td>
              </tr>
              <tr>
                <td>$FE</td>
                <td>Enable EVSE</td>
              </tr>
              <tr>
                <td>$FP</td>
                <td>Output text at x y position text to LCD (x y text)</td>
              </tr>
              <tr>
                <td>$FR</td>
                <td>Reset EVSE</td>
              </tr>
              <tr>
                <td>$FS</td>
                <td>Put EVSE to sleep</td>
              </tr>
              <tr>
                <td>$FF</td>
                <td>Enable/disable feature (feature_id 0|1)<br>
                    Front panel (B)utton, (D)iode check, G(F)I self-test, (G)round check,
                    Stuck (R)elay check, (T)emp monitoring, (V)ent required</td>
              </tr>
            </table>
          </div>
        </div>
        <!--end TAB 4-->

        <!--TAB 5: Vehicle -->
        <div id="content-5" data-bind="visible: isVehicle">
          <div class="box380 left">
            <h2>Setup</h2>
            <select data-bind="value: vehicle.type">
              <option value="none">None</option>
              <option value="tesla">Tesla</option>
              <!-- option value="ovms">OVMS</option -->
              <option value="mqtt">MQTT</option>
            </select>

            <div data-bind="visible: 'none' == vehicle.type()">
              <p>Select the vehicle connection type</p>
            </div>

            <div data-bind="visible: 'tesla' == vehicle.type()">
              <hr/>
              <h3>Tesla</h3>
              <p data-bind="visible: !vehicle.tesla.have_credentials() &amp;&amp; !vehicle.tesla.advanced()">
                <b>Username:</b>
                <input data-bind="textInput: vehicle.tesla.username" type="text" autocapitalize="none">
              </p>
              <p data-bind="visible: !vehicle.tesla.have_credentials() &amp;&amp; !vehicle.tesla.advanced()">
                <b>Password:</b>
                <input type="password" autocapitalize="none" data-bind="textInput: vehicle.tesla.password" /><br />
                <!--span>
                  <input id="mqttPassword" type="checkbox" data-bind="checked: mqttPassword.show" />
                  <label for="mqttPassword">Show password</label>
                </span-->
              </p>
              <p data-bind="visible: !vehicle.tesla.have_credentials() &amp;&amp; vehicle.tesla.advanced()">
                <b>Access token</b>
                <input data-bind="textInput: config.tesla_access_token" type="password" autocapitalize="none">
                <!--span>
                  <input id="mqttPassword" type="checkbox" data-bind="checked: mqttPassword.show" />
                  <label for="mqttPassword">Show password</label>
                </span-->
              </p>
              <p data-bind="visible: !vehicle.tesla.have_credentials() &amp;&amp; vehicle.tesla.advanced()">
                <b>Refresh token</b>
                <input data-bind="textInput: config.tesla_refresh_token" type="password" autocapitalize="none">
                <!--span>
                  <input id="mqttPassword" type="checkbox" data-bind="checked: mqttPassword.show" />
                  <label for="mqttPassword">Show password</label>
                </span-->
              </p>
              <div class="box" data-bind="visible: showTeslaAdvancedInfo()">
                The Tesla login may break from time-to-time as Tesla change their login API, hopefully OpenEVSE will be able to resolve the
                issue on <a href="https://github.com/OpenEVSE/ESP32_WiFi_V4.x/tree/master/tesla_login" target="_blank">our server</a>,
                but should the login fail you can use a 3rd Party app to generate the appropriate tokens.

                <ul>
                  <li><b>Apple</b>: <a href="https://apps.apple.com/us/app/auth-app-for-tesla/id1552058613" target="_blank">Auth app for Tesla</a></li>
                  <li><b>Andriod</b>: <a href="https://play.google.com/store/apps/details?id=net.leveugle.teslatokens&hl=en_GB&gl=US" target="_blank">Tesla Tokens</a></li>
                </ul>

                These can be entered in the `Advanced` section as an alternative method of logging in.
              </div>
              <p data-bind="visible: vehicle.tesla.have_credentials()">
                <select data-bind="options: vehicle.tesla.vehicles,
                  optionsText: 'name',
                  optionsValue: 'id',
                  value: config.tesla_vehicle_id,
                  visible: vehicle.tesla.vehicles().length > 0">
                </select>
                <span data-bind="visible: 0 == vehicle.tesla.vehicles().length">
                  Fetching vehicle info ...
                </span>
              </p>
            </div>

            <div data-bind="visible: 'ovms' == vehicle.type()">
              <hr/>
              <h3>Open Vehicle Monitoring System</h3>

            </div>

            <div data-bind="visible: 'mqtt' == vehicle.type()">
              <hr/>
              <h3>MQTT</h3>

              <div class="box error" data-bind="visible: !config.mqtt_enabled()">
                <h4>MQTT not enabled.</h4>
                You need to enable MQTT on the <a href="#services">Services</a> tab.
              </div>

              <p data-bind="visible: config.mqtt_enabled()">
                <b>State of Charge topic:</b><br>
                <input data-bind="textInput: config.mqtt_vehicle_soc" type="text" autocapitalize="none"><br>
                <span class="small-text">The battery level of charge as a percentage</span>
              </p>

              <div data-bind="visible: config.mqtt_enabled()">
                <b>Range topic:</b><br>
                <div class="divert">
                  <input data-bind="textInput: config.mqtt_vehicle_range" type="text" autocapitalize="none">
                  <select data-bind="value: vehicle.mqtt_vehicle_range_units">
                    <option value="km">km</option>
                    <option value="mi">miles</option>
                  </select><br/>
                  <span class="small-text">The range (on electric) of the vehicle based on the current battery level</span>
                </div>
              </div>

              <p data-bind="visible: config.mqtt_enabled()">
                <b>Time to charge topic:</b><br>
                <input data-bind="textInput: config.mqtt_vehicle_eta" type="text" autocapitalize="none"><br>
                <span class="small-text">The time until the battery is fully charged in seconds</span>
              </p>

            </div>

            <p data-bind="">
              <button data-bind="visible: vehicle.show_save(),
                                 click: vehicleStateGroup.save,
                                 text: (vehicleStateGroup.fetching() ? 'Saving' : (vehicleStateGroup.success() ? 'Saved' : 'Save')),
                                 disable: vehicleStateGroup.fetching">
                Save
              </button>
              <button data-bind="visible: !vehicle.tesla.have_credentials() && !vehicle.show_save(),
                                  click: vehicle.tesla.login,
                                  text: (vehicle.tesla.fetching() ? 'Saving' : (vehicle.tesla.success() ? 'Saved' : 'Login')),
                                  disable: vehicle.tesla.fetching">
                Login
              </button>
              <button data-bind="visible: !vehicle.tesla.have_credentials() && !vehicle.show_save(),
                                 click: vehicle.tesla.showAdvanced">
                Advanced
              </button>
              <span class="info" data-bind="visible: !vehicle.tesla.have_credentials() && !vehicle.show_save(),
                                            click: toggle.bind($data, showTeslaAdvancedInfo)"></span>
              <button data-bind="visible: vehicle.tesla.have_credentials(),
                                 click: vehicle.tesla.logout,
                                 text: (vehicle.tesla.fetching() ? 'Saving' : (vehicle.tesla.success() ? 'Saved' : 'Logout')),
                                 disable: vehicle.tesla.fetching">
                Logout
              </button>
            </p>

          </div>

          <div class="box380 right error" data-bind="visible: false !== status.tesla_error()">
            <h4>Error</h4>
            <span data-bind="text: status.tesla_error"></span>
          </div>

          <div class="box380 right" data-bind="visible: vehicle.has_status">
            <h2>Status</h2>
            <table>
              <tr>
                <th>Status</th>
                <th><span data-bind="text: formatUpdate(openevse.time.vehicle_state_update()), css: updateClass(openevse.time.vehicle_state_update())"></span></th>
              </tr>
              <tr data-bind="visible: false !== status.battery_level()">
                <td>Battery Level:</td>
                <td><span data-bind="text: status.battery_level()+ '%'"></span></td>
              </tr>
              <tr data-bind="visible: false !== status.battery_range()">
                <td>Battery Range:</td>
                <td><span data-bind="text: status.battery_range() + ' ' + (vehicle.mqtt_vehicle_range_units())"></span></td>
              </tr>
              <tr data-bind="visible: false !== status.time_to_full_charge()">
                <td>Time to full charge:</td>
                <td><span data-bind="text: new Date(status.time_to_full_charge() * 1000).toISOString().substr(11, 8)"></span></td>
              </tr>
            </table>
          </div>
        </div>
        <!--end TAB 5-->

      </div>
      <!--end content-->

      <div id="footer">
        <br><b> Powered by <a href="http://www.openevse.com">OpenEVSE</a> and <a href="https://openenergymonitor.org">OpenEnergyMonitor</a></b>
        <br>
        <b>Version: </b>V<span data-bind="text: config.version"></span>
      </div>
    </div>
    <!--end container -->
  </div>

  <!--end page -->
  <script src="lib.js"></script>
  <script src="home.js"></script>
</body>

</html>
